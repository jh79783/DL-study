# 합성곱 신경망 (Convolution layer)

합성곱 신경망은 저수준의 패턴(edge, blob 등)이 조합되어 복잡한 패턴(texture, object 등)에 반응한다는 관찰을 통해 등장하게 되었다.

5장과 6장에서 모든 이미지의 픽셀이 연결되어 있는 fully connected layer를 사용하였다.
들어온 이미지를 affine으로 명시된 fully-connected 연산과 ReLU와같은 비선형 함수의 계층을 여러층 쌓은 구조이다.

![fully connect](..\img\fully connect.jpg)

이번 7장에서 사용할 CNN의 구조는 합성곱 계층과 풀링층이라고 하는 새로운 계층을 fully-connected 앞에 추가 함으로 써 연산이 수행하도록 한다.

![cnn connect](..\img\cnn connect.jpg)

합성곱 계층은 이미지에 필터링 기법(합성곱 연산)이 적용되며, 풀링 계층은 이미지의 국소적인 부분을 대표스칼라 값으로 변환하여 이미지의 크기를 줄여주는 역할을 한다. 풀링에도 여러기법이 있지만, 이미지 인식에서는 최대풀링과 평균풀링을 주로 사용한다.



5장에서 우리는 입력데이터를 1차원으로 바꾸어 넣었다. 

> 입력데이터 = 가로\*세로\*채널 

앞의 공식에 의해 100\*100\*3=30000개를 입력데이터로 사용하였다. 이것이 fully conneceted layer인데, 이것의 문제점은 **데이터의 형상이 무시**된다는 것이다. (같은 차원의 뉴런으로 취급)
이미지 데이터는 3차원 공간에서 다음과 같은 많은 정보가 내포되어 있다.

> RGB채널의 연관성
> 공간적으로 가까운 픽셀과의 연관성
> 거리가 먼 픽셀과의 무연관성

1차원으로 바꾸어 펼쳐주게되면 이러한 정보가 모두 무시된다.
입력데이터의 형상을 유지시켜주기 위해 CNN에서는 이미지 데이터의 3차원을 그대로 입력층에 입력받게 된다.
이때 사용하는 이미지 데이터는 **(높이,넓이,채널)**의 3차원인 텐서(tensor)로 표현을 한다.

개념적으로는 3차원 텐서지만 현실적으로는 4차원 텐서를 이용한다고한다. 병렬처리를 하기 위함이라는데 잘 모르겠다.



## 합성곱 연산

합성곱 연산을 통하여 feature map을 추출한다.
합성곱층에서는 커널 혹은 필터라고 불리는 n\*m의 매트릭스?를 사용한다.
즉, 이 커널이 합성곱층에서의 가중치 파라미터 Weight에 해당하게 되며 이를 통해 feature map을 추출하여 다음 층으로 전달한다.

![합성곱 연산](..\img\합성곱 연산.jpg)

합성곱 연산을 진행하게 되면 출력 이미지가 입력 이미지보다 작아지게 되는데, 이것이 여러 층을 통과하게 되면 가장자리에 있는 픽셀의 정보는 사라지게 된다.이러한 문제를 해결하는 것이 패딩(padding)이다.
패딩을 할 때 채울 값을 지정할 수 있지만, 주로 0으로 채워 사용하게 된다(zero-padding).
패딩 방식에는 SAME과 VALID방식이 있다.
SAME패딩은 입력과 같은 크기의 출력이 만들어지게 된다.
VALID패딩은 출력이 입력보다 적어지게 되지만 출력 픽셀 계산에 유용한 픽셀들만 이용된다. 하지만 SAME패딩이 구조를 설계하기 쉽고, 반복하기도 유리하기 때문에 SAME패딩이 더 널리 사용된다.

입력 픽셀로부터 출력 픽셀을 생성하는데 이때 일정한 간격을 건너뛰며 생성할 수 있다. 즉, 출력계층의 데이터 크기를 조절할 수 있다는 것이다. 이것을 스트라이드(Stride)라고 한다.
스트라이드는 이미지 크기를 줄여 이미지를 처리하는데 부담을 줄여주지만 그만큼 정보를 무시하게 된다. 따라서 합성곱층에서보다 풀링계층에서 더 많이 사용된다.

## 풀링

평균값 풀링의 경우 모든 입력 픽셀값이 출력에 반영된다. 그에 비해 최대값 풀링의 경우 반영되지 않는 입력 픽셀이 생기는데 이들은 합성곱 계층에서의 스트라이드 처럼 무시당하지 않는다. 왜냐하면 최대값을 뽑는 과정에서 간접적으로 영향을 미치기 때문이다.

## 채널과 커널의 확장

